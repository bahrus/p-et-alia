import{XtallatX}from"xtal-element/xtal-latx.js";import{hydrate}from"trans-render/hydrate.js";const on="on",noblock="noblock",iff="if",to="to",prop="prop",val="val",stcRe=/(\-\w)/g;function getProp(t,e){let s=t;return e.forEach(t=>{if(s)switch(typeof t){case"string":s=s[t];break;default:s=s[t[0]].apply(s,t[1])}}),s}export class P extends(XtallatX(hydrate(HTMLElement))){constructor(){super(),this._s=null,this._lastEvent=null}get on(){return this._on}set on(t){this.attr(on,t)}get to(){return this._to}set to(t){this.attr(to,t)}get noblock(){return this._noblock}set noblock(t){this.attr(noblock,t,"")}get if(){return this._if}set if(t){this.attr(iff,t)}get prop(){return this._prop}set prop(t){switch(typeof t){case"symbol":this._prop=t;break;default:this.attr(prop,t)}}get val(){return this._val}set val(t){this.attr(prop,t)}static get observedAttributes(){return super.observedAttributes.concat([on,to,noblock,iff,prop,val])}getSplit(t){return"."===t?[]:t.split(".")}attributeChangedCallback(t,e,s){const i="_"+t;switch(t){case iff:case on:case prop:case val:case to:this[i]=s;break;case noblock:this[i]=null!==s}t===val&&null!==s&&(this._s=this.getSplit(s)),super.attributeChangedCallback(t,e,s)}getPreviousSib(){let t=this;for(;t&&t.tagName.startsWith("P-");)t=t.previousElementSibling;return null===t&&(t=this.parentElement),t}connectedCallback(){this.style.display="none",this.propUp([on,to,noblock,iff,prop,val]),this.init()}init(){this.attchEvListnrs(),this.doFake()}attchEvListnrs(){if(this._bndHndlEv)return;this._bndHndlEv=this._hndEv.bind(this);const t=this.getPreviousSib();if(!t)return;t.addEventListener(this._on,this._bndHndlEv);const e=t.getAttribute("disabled");null!==e&&(0===e.length||"1"===e?t.removeAttribute("disabled"):t.setAttribute("disabled",(parseInt(e)-1).toString()))}skI(){return this.hasAttribute("skip-init")}doFake(){if(!this._if&&!this.skI()){let t=this._lastEvent;t||(t={target:this.getPreviousSib(),isFake:!0}),this._hndEv&&this._hndEv(t)}}_hndEv(t){this.hasAttribute("debug"),t&&(t.stopPropagation&&!this._noblock&&t.stopPropagation(),this._if&&!t.target.matches(this._if)||(this._lastEvent=t,this.pass(t)))}$N(t,e){return null==t?e:t}valFromEvent(t,e=null){const s=e||this._s;return null!==s?getProp(t,s):this.$N(getProp(t,["detail","value"]),getProp(t,["target","value"]))}setVal(t,e){this.commit(e,this.valFromEvent(t),t)}commit(t,e,s){let i=e,n=this._prop;if(void 0===n){const e=this.to.split("["),r=e.length;if(r>1){const o=e[r-1].replace("]","");if(o.endsWith("\\:")){n=o.slice(0,-2);const e=t.getAttribute(n+":");e&&(i=this.valFromEvent(s,e.split(".")))}}}void 0!==i&&(t[n]=i)}detach(t){t.removeEventListener(this._on,this._bndHndlEv)}disconnectedCallback(){const t=this.getPreviousSib();t&&this._bndHndlEv&&this.detach(t)}}